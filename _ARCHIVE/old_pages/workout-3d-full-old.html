<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>S√©ance - Hybrid Master 63</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .trapbar-screen {
        min-height: 100vh;
        background: #000000;
        color: white;
        padding: 20px 20px calc(140px + env(safe-area-inset-bottom)) 20px;
        padding-top: max(20px, env(safe-area-inset-top));
        overflow-x: hidden;
        position: relative;
    }

    .trapbar-screen::before {
        content: '';
        position: fixed;
        inset: 0;
        background: 
            radial-gradient(circle 1200px at 25% 45%, rgba(53, 255, 139, 0.08), transparent 70%),
            radial-gradient(circle 1300px at 50% 45%, rgba(255, 179, 71, 0.10), transparent 75%),
            radial-gradient(circle 1250px at 75% 45%, rgba(124, 58, 237, 0.07), transparent 70%);
        filter: blur(200px);
        pointer-events: none;
        z-index: 0;
        opacity: 0.3;
    }

    .trapbar-particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
        z-index: 5;
    }

    .particle {
        position: absolute;
        border-radius: 50%;
        background: #ffd700;
        opacity: 0.7;
        animation: float-particle 5s infinite ease-in-out;
        box-shadow: 0 0 6px #ffd700;
    }

    @keyframes float-particle {
        0%, 100% { transform: translateY(0) translateX(0); opacity: 0.7; }
        50% { transform: translateY(-20px) translateX(10px); opacity: 0.3; }
    }

    .trapbar-back-btn {
        position: absolute;
        top: max(20px, env(safe-area-inset-top));
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(20,20,20,0.6);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 100;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 4px 16px rgba(0,0,0,0.6);
    }

    .trapbar-back-btn:hover {
        background: rgba(40,40,40,0.7);
        transform: scale(1.1);
    }

    .trapbar-back-btn::before,
    .trapbar-back-btn::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 2px;
        background: white;
    }

    .trapbar-back-btn::before { transform: rotate(45deg); }
    .trapbar-back-btn::after { transform: rotate(-45deg); }

    .trapbar-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        position: relative;
        z-index: 2;
    }

    .trapbar-trophy {
        width: 60px;
        height: 60px;
        background: rgba(10, 10, 10, 0.8);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 215, 0, 0.12);
        box-shadow: 0 8px 24px rgba(0,0,0,0.7);
        flex-shrink: 0;
    }

    .trapbar-trophy::before {
        content: 'üèÜ';
    }

    .trapbar-title-wrapper h1 {
        font-size: clamp(26px, 7vw, 42px);
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
    }

    .trapbar-title-white {
        color: white;
    }

    .trapbar-title-cyan {
        background: linear-gradient(135deg, #00E5FF 0%, #00FFD0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 0 40px rgba(0, 229, 255, 0.9));
    }

    .trapbar-subtitle {
        color: #7a8090;
        font-size: clamp(10px, 2.5vw, 14px);
        margin-top: 6px;
        letter-spacing: 1.5px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .trapbar-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 30px;
        position: relative;
        z-index: 2;
    }

    .trapbar-metric-card {
        background: linear-gradient(135deg, rgba(20,25,35,0.5) 0%, rgba(10,15,25,0.4) 100%);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 18px;
        padding: 16px;
        text-align: center;
        cursor: pointer;
        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }

    .trapbar-metric-icon {
        font-size: clamp(40px, 10vw, 64px);
        margin-bottom: 8px;
        filter: drop-shadow(0 0 20px currentColor);
    }

    .trapbar-metric-value {
        font-size: clamp(24px, 6vw, 38px);
        font-weight: 700;
        margin-bottom: 4px;
        text-shadow: 0 0 35px currentColor;
    }

    .trapbar-metric-value.orange { color: #FF6D00; }
    .trapbar-metric-value.cyan { color: #00D9FF; }
    .trapbar-metric-value.green { color: #35FF8B; }
    .trapbar-metric-value.violet { color: #9D4EDD; }

    .trapbar-metric-label {
        color: #8a91a0;
        font-size: clamp(9px, 2.2vw, 12px);
        letter-spacing: 1.2px;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* CERCLES CENTR√âS */
    .trapbar-circles-container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin: 30px 0 40px 0;
        min-height: 200px;
        z-index: 10;
        padding: 15px 5px;
    }

    @media (max-width: 600px) {
        .trapbar-circles-container {
            overflow-x: auto;
            overflow-y: hidden;
            justify-content: flex-start;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .trapbar-circles-container::-webkit-scrollbar {
            display: none;
        }
    }

    .trapbar-circle-wrapper {
        position: relative;
        width: 170px;
        min-width: 170px;
        max-width: 170px;
        height: 170px;
        flex-shrink: 0;
        scroll-snap-align: center;
    }

    @media (min-width: 768px) {
        .trapbar-circle-wrapper {
            width: 220px;
            min-width: 220px;
            max-width: 220px;
            height: 220px;
        }
        .trapbar-circles-container {
            gap: 40px;
        }
    }

    .trapbar-circle-wrapper.green {
        filter: 
            drop-shadow(0 0 40px rgba(53, 255, 139, 0.8))
            drop-shadow(0 0 80px rgba(0, 212, 255, 0.6))
            drop-shadow(0 0 120px rgba(157, 78, 221, 0.4));
    }

    .trapbar-circle-wrapper.orange {
        filter: 
            drop-shadow(0 0 50px rgba(255, 179, 71, 0.9))
            drop-shadow(0 0 100px rgba(255, 109, 0, 0.7))
            drop-shadow(0 0 150px rgba(255, 200, 0, 0.5));
    }

    .trapbar-circle-wrapper.blue {
        filter: 
            drop-shadow(0 0 45px rgba(0, 217, 255, 0.8))
            drop-shadow(0 0 90px rgba(124, 58, 237, 0.6))
            drop-shadow(0 0 140px rgba(157, 78, 221, 0.4));
    }

    .trapbar-circle-svg {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        animation: rotate-border 8s linear infinite;
    }

    @keyframes rotate-border {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .trapbar-circle-inner {
        position: absolute;
        inset: 5px;
        background: radial-gradient(circle at center, rgba(0,0,0,0.95) 0%, rgba(0,0,0,1) 70%);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .trapbar-circle-check {
        font-size: clamp(60px, 15vw, 95px);
        font-weight: 700;
        color: #35FF8B;
        text-shadow: 0 0 50px rgba(53, 255, 139, 1.0), 0 0 100px rgba(53, 255, 139, 0.8);
    }

    .trapbar-circle-progress {
        font-size: clamp(14px, 3vw, 20px);
        color: #35FF8B;
        margin-top: -4px;
        font-weight: 700;
    }

    .trapbar-circle-weight {
        font-size: clamp(48px, 12vw, 76px);
        font-weight: 800;
        color: #FF6D00;
        text-shadow: 0 0 60px rgba(255, 109, 0, 1.0), 0 0 120px rgba(255, 179, 71, 0.9);
    }

    .trapbar-circle-unit {
        font-size: clamp(18px, 4vw, 28px);
        font-weight: 600;
        color: #FF6D00;
        margin-top: -6px;
        text-shadow: 0 0 40px rgba(255, 109, 0, 0.9);
    }

    .trapbar-circle-reps {
        font-size: clamp(48px, 12vw, 76px);
        font-weight: 800;
        color: #00D9FF;
        text-shadow: 0 0 60px rgba(0, 217, 255, 1.0), 0 0 120px rgba(124, 58, 237, 0.9);
    }

    .trapbar-circle-reps-label {
        font-size: clamp(16px, 3.5vw, 24px);
        font-weight: 600;
        color: #00D9FF;
        margin-top: -6px;
        text-shadow: 0 0 40px rgba(0, 217, 255, 0.9);
    }

    .trapbar-series-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin: 40px 0 30px 0;
        position: relative;
        z-index: 2;
    }

    .trapbar-serie-row {
        display: grid;
        grid-template-columns: 70px 1fr 60px 75px;
        align-items: center;
        gap: 12px;
        background: linear-gradient(135deg, rgba(20,25,35,0.4) 0%, rgba(10,15,25,0.3) 100%);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 18px;
        padding: 12px 16px;
        transition: all 0.3s;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        min-height: 90px;
    }

    @media (min-width: 768px) {
        .trapbar-serie-row {
            grid-template-columns: 90px 1fr 80px 95px;
            padding: 16px 20px;
            min-height: 105px;
        }
    }

    .trapbar-serie-row:hover {
        transform: translateX(6px);
        box-shadow: 0 6px 30px rgba(0,0,0,0.5);
    }

    .trapbar-serie-small-circle {
        width: 70px;
        height: 70px;
        min-width: 70px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 35%, rgba(255,220,150,1) 0%, rgba(255,140,40,0.9) 30%, rgba(255,90,0,0.7) 50%, rgba(0,0,0,0.9) 100%);
        border: 2px solid rgba(255,109,0,0.6);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 
            0 6px 20px rgba(255,109,0,0.6),
            inset -3px -3px 8px rgba(0,0,0,0.7),
            inset 2px 2px 6px rgba(255,179,71,0.4);
    }

    @media (min-width: 768px) {
        .trapbar-serie-small-circle {
            width: 80px;
            height: 80px;
            min-width: 80px;
        }
    }

    .trapbar-serie-small-num {
        font-size: clamp(20px, 5vw, 26px);
        font-weight: 700;
        color: #FF6D00;
        text-shadow: 0 0 15px rgba(255,109,0,0.8);
    }

    .trapbar-serie-small-unit {
        font-size: clamp(11px, 2.5vw, 14px);
        font-weight: 600;
        color: #FF6D00;
        margin-top: -3px;
        text-shadow: 0 0 10px rgba(255,109,0,0.6);
    }

    .trapbar-serie-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }

    .trapbar-serie-badge {
        padding: 10px 20px;
        border-radius: 16px;
        font-size: clamp(12px, 3vw, 15px);
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    @media (min-width: 768px) {
        .trapbar-serie-badge {
            padding: 12px 28px;
            border-radius: 18px;
        }
    }

    .trapbar-serie-badge.dropset {
        background: linear-gradient(180deg, #00E5FF 0%, #00D9FF 100%);
        color: #000;
        box-shadow: 
            0 6px 25px rgba(0,217,255,0.7),
            inset 0 2px 4px rgba(255,255,255,0.5),
            inset 0 -3px 6px rgba(0,0,0,0.3);
    }

    .trapbar-serie-badge.restpause {
        background: linear-gradient(180deg, #A855F7 0%, #7c3aed 100%);
        color: white;
        box-shadow: 
            0 6px 25px rgba(157,78,221,0.7),
            inset 0 2px 4px rgba(255,255,255,0.4),
            inset 0 -3px 6px rgba(0,0,0,0.4);
    }

    .trapbar-serie-badge.clusters {
        background: linear-gradient(180deg, #FF6D00 0%, #FFB347 100%);
        color: white;
        box-shadow: 
            0 6px 25px rgba(255,109,0,0.7),
            inset 0 2px 4px rgba(255,255,255,0.4),
            inset 0 -3px 6px rgba(0,0,0,0.4);
    }

    .trapbar-serie-badge.partials {
        background: linear-gradient(180deg, #35FF8B 0%, #00FFD0 100%);
        color: #000;
        box-shadow: 
            0 6px 25px rgba(53,255,139,0.7),
            inset 0 2px 4px rgba(255,255,255,0.5),
            inset 0 -3px 6px rgba(0,0,0,0.3);
    }

    .trapbar-serie-text {
        font-size: clamp(20px, 5vw, 26px);
        font-weight: 700;
        color: white;
        text-shadow: 0 0 20px rgba(255,255,255,0.5);
    }

    .trapbar-serie-tempo {
        font-size: clamp(10px, 2.5vw, 12px);
        color: #35FF8B;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .trapbar-serie-reps-badge {
        font-size: clamp(18px, 4.5vw, 24px);
        font-weight: 700;
        color: #00D9FF;
        text-shadow: 0 0 20px rgba(0,217,255,0.7);
    }

    .trapbar-serie-checkbox {
        width: 75px;
        height: 75px;
        min-width: 75px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.4s;
    }

    @media (min-width: 768px) {
        .trapbar-serie-checkbox {
            width: 85px;
            height: 85px;
            min-width: 85px;
        }
    }

    .trapbar-serie-checkbox:hover {
        transform: scale(1.1);
    }

    .trapbar-serie-checkbox.completed {
        background: linear-gradient(135deg, #00E5FF, #00D9FF);
        box-shadow:
            0 0 70px rgba(0,217,255,1.0),
            0 0 140px rgba(0,217,255,0.8),
            0 8px 24px rgba(0,0,0,0.6),
            inset 0 2px 8px rgba(255,255,255,0.6);
    }

    .trapbar-serie-checkbox.uncompleted-first {
        background: rgba(0,217,255,0.15);
        border: 4px solid #00D9FF;
        box-shadow: 0 0 50px rgba(0,217,255,0.8), inset 0 0 30px rgba(0,217,255,0.3);
    }

    .trapbar-serie-checkbox.uncompleted-gray {
        background: rgba(130,160,200,0.2);
        border: 3px solid rgba(147,197,253,0.5);
        box-shadow: inset 0 0 20px rgba(147,197,253,0.2);
    }

    .trapbar-serie-checkbox.uncompleted-beige {
        background: rgba(200,200,200,0.1);
        border: 2px solid rgba(220,220,220,0.3);
        box-shadow: inset 0 0 15px rgba(200,200,200,0.1);
    }

    .trapbar-serie-row.completed {
        background: linear-gradient(135deg, rgba(0,217,255,0.25) 0%, rgba(0,217,255,0.15) 100%);
        box-shadow: 
            inset 0 0 80px rgba(0,217,255,0.3),
            0 0 50px rgba(0,217,255,0.4);
    }

    /* TIMER AVEC VISUALISATION TEMPO */
    .trapbar-footer {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(20,25,35,0.45) 0%, rgba(10,15,25,0.35) 100%);
        backdrop-filter: blur(30px);
        border-radius: 20px;
        margin-top: 40px;
        border: 1px solid rgba(255,255,255,0.08);
        position: relative;
        z-index: 2;
        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }

    .trapbar-footer-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .trapbar-footer-label {
        color: #8a91a0;
        font-size: clamp(9px, 2vw, 11px);
        letter-spacing: 1.2px;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .trapbar-timer {
        font-size: clamp(36px, 10vw, 58px);
        font-weight: 800;
        color: white;
        text-shadow: 0 0 45px rgba(255,255,255,0.8);
    }

    .trapbar-volume {
        font-size: clamp(18px, 5vw, 26px);
        font-weight: 700;
        color: #9ca3af;
        text-shadow: 0 0 30px rgba(156,163,175,0.7);
    }

    .tempo-bar-container {
        width: 100%;
        height: 40px;
        background: rgba(20,25,35,0.6);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .tempo-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #35FF8B 0%, #00D9FF 50%, #FF6D00 100%);
        transition: width 0.1s linear;
        box-shadow: 0 0 20px rgba(53,255,139,0.8);
    }

    .tempo-phases {
        display: flex;
        justify-content: space-around;
        margin-top: 8px;
    }

    .tempo-phase {
        font-size: clamp(10px, 2.5vw, 12px);
        color: #8a91a0;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .tempo-phase.active {
        color: #35FF8B;
        text-shadow: 0 0 10px rgba(53,255,139,0.8);
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin: 30px 0 20px 0;
      position: relative;
      z-index: 100;
    }
    
    .nav-btn {
      flex: 1;
      padding: 16px 24px;
      border: none;
      border-radius: 16px;
      font-size: clamp(14px, 3.5vw, 17px);
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.5px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    
    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: rgba(255,255,255,0.05);
      color: #666;
    }
    
    .nav-btn.prev {
      background: linear-gradient(135deg, #00D9FF, #00E5FF);
      color: #000;
    }
    
    .nav-btn.next {
      background: linear-gradient(135deg, #35FF8B, #00FFD0);
      color: #000;
    }
    
    .nav-btn:not(:disabled):hover {
      transform: translateY(-3px);
    }
.timer-button-container {
      padding: 30px 20px;
      display: flex;
      justify-content: center;
    }
    
    .timer-start-btn {
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(0, 255, 136, 0.2));
      border: 2px solid #00ff88;
      border-radius: 50px;
      padding: 20px 40px;
      color: #00ff88;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 1px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
      transition: all 0.3s;
    }
    
    .timer-start-btn:active {
      transform: scale(0.95);
      box-shadow: 0 0 50px rgba(0, 255, 136, 0.6);
    }
    
    .timer-icon {
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script type="module">
    import programData from './scripts/program-data.js?v=20251116-014';
    
    const urlParams = new URLSearchParams(window.location.search);
    const weekNumber = parseInt(urlParams.get('week')) || 1;
    const dayKey = urlParams.get('day') || 'dimanche';
    
    const weekData = programData.getWeek(weekNumber);
    const workout = weekData[dayKey];
    
    if (!workout) {
      document.getElementById('app').innerHTML = '<div style="color:white;padding:40px;text-align:center;">S√©ance introuvable</div>';
      throw new Error('Workout not found');
    }
    
    let currentExerciseIndex = 0;
    let completedSets = workout.exercises.map(ex => Array(ex.sets).fill(false));
    let timer = 0;
    let timerInterval = null;
    let tempoTimer = null;
    let currentPhase = 0;
    
    function parseReps(reps) {
      if (typeof reps === 'number') return reps;
      const str = String(reps);
      const match = str.match(/(\d+)/);
      return match ? parseInt(match[1]) : 8;
    }
    
    function parseTempo(tempo) {
      if (!tempo) return [3, 1, 2];
      const parts = String(tempo).split('-');
      return parts.map(p => parseInt(p) || 0);
    }
    
    function startTimer() {
      if (timerInterval) return;
      timerInterval = setInterval(() => {
        timer++;
        const el = document.getElementById('trapbar-timer');
        if (el) {
          const m = Math.floor(timer / 60);
          const s = timer % 60;
          el.textContent = m + ':' + String(s).padStart(2, '0');
        }
      }, 1000);
    }
    
    function startTempoTimer() {
      const exercise = workout.exercises[currentExerciseIndex];
      const tempo = parseTempo(exercise.tempo);
      const totalDuration = tempo.reduce((a, b) => a + b, 0);
      let elapsed = 0;
      
      currentPhase = 0;
      
      if (tempoTimer) clearInterval(tempoTimer);
      
      tempoTimer = setInterval(() => {
        elapsed += 0.1;
        const percentage = (elapsed / totalDuration) * 100;
        
        const bar = document.getElementById('tempo-bar');
        if (bar) bar.style.width = percentage + '%';
        
        // D√©terminer la phase actuelle
        let phaseTime = 0;
        for (let i = 0; i < tempo.length; i++) {
          phaseTime += tempo[i];
          if (elapsed < phaseTime) {
            if (currentPhase !== i) {
              currentPhase = i;
              updateTempoPhases();
            }
            break;
          }
        }
        
        if (elapsed >= totalDuration) {
          clearInterval(tempoTimer);
          tempoTimer = null;
          if (bar) bar.style.width = '0%';
          currentPhase = 0;
          updateTempoPhases();
        }
      }, 100);
    }
    
    function updateTempoPhases() {
      const phases = ['Descente', 'Pause', 'Mont√©e'];
      phases.forEach((_, i) => {
        const el = document.getElementById(`tempo-phase-${i}`);
        if (el) {
          el.className = 'tempo-phase' + (i === currentPhase ? ' active' : '');
        }
      });
    }
    
    function toggleSet(index) {
      completedSets[currentExerciseIndex][index] = !completedSets[currentExerciseIndex][index];
      if (navigator.vibrate) navigator.vibrate([30]);
      
      // D√©marrer le timer au premier clic
      if (!timerInterval) startTimer();
      
      // D√©marrer le tempo timer
      if (completedSets[currentExerciseIndex][index]) {
        startTempoTimer();
      }
      
      render();
    }
    
    function goToPrevious() {
      if (currentExerciseIndex > 0) {
        currentExerciseIndex--;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        render();
      }
    }
    
    function goToNext() {
      if (currentExerciseIndex < workout.exercises.length - 1) {
        currentExerciseIndex++;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        render();
      }
    }
    
    function detectIntensification(notes, serieIndex) {
      if (!notes) return null;
      
      const noteUpper = notes.toUpperCase();
      
      const serieMatch = notes.match(/S(\d+)/);
      if (serieMatch) {
        const targetSerie = parseInt(serieMatch[1]);
        if (serieIndex + 1 !== targetSerie) return null;
      }
      
      if (noteUpper.includes('REST-PAUSE')) return { type: 'restpause', label: 'REST PAUSE' };
      if (noteUpper.includes('DROP-SET')) return { type: 'dropset', label: 'DROP SET' };
      if (noteUpper.includes('CLUSTERS')) return { type: 'clusters', label: 'CLUSTERS' };
      if (noteUpper.includes('PARTIALS')) return { type: 'partials', label: 'PARTIALS' };
      
      return null;
    }
    
    function getWeightIcon() {
      return '<svg width="64" height="64" viewBox="0 0 64 64" fill="none"><rect x="5" y="26" width="8" height="12" rx="2" fill="url(#wg)"/><rect x="51" y="26" width="8" height="12" rx="2" fill="url(#wg)"/><rect x="13" y="29" width="38" height="6" rx="3" fill="url(#wg)"/><defs><linearGradient id="wg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#b0b0b0"/><stop offset="100%" stop-color="#707070"/></linearGradient></defs></svg>';
    }
    
    function getSeriesIcon() {
      return '<svg width="64" height="64" viewBox="0 0 64 64" fill="none"><rect x="16" y="18" width="32" height="8" rx="4" fill="#00D9FF" opacity="0.4"/><rect x="18" y="27" width="28" height="8" rx="4" fill="#00D9FF" opacity="0.7"/><rect x="20" y="36" width="24" height="8" rx="4" fill="#00D9FF"/></svg>';
    }
    
    function getTempoIcon() {
      return '<svg width="64" height="64" viewBox="0 0 64 64" fill="none"><path d="M32 10L38 28L32 46L26 28L32 10Z" fill="url(#lg)"/><defs><linearGradient id="lg" x1="32" y1="10" x2="32" y2="46"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#35FF8B"/></linearGradient></defs></svg>';
    }
    
    function getRestIcon() {
      return '<svg width="64" height="64" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="16" fill="url(#rg)"/><defs><radialGradient id="rg"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#b0b0b0"/></radialGradient></defs></svg>';
    }
    
    function createParticles() {
      const container = document.getElementById('trapbar-particles');
      if (!container) return;
      container.innerHTML = '';
      
      const pos = [{x:25,y:42},{x:50,y:42},{x:75,y:42}];
      for (let i = 0; i < 100; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const t = pos[Math.floor(Math.random() * 3)];
        const d = Math.random() < 0.7 ? Math.random() * 300 : (Math.random() < 0.9 ? 300 + Math.random() * 200 : 500 + Math.random() * 300);
        const a = Math.random() * Math.PI * 2;
        const x = t.x + (Math.cos(a) * d / window.innerWidth * 100);
        const y = t.y + (Math.sin(a) * d / window.innerHeight * 100);
        p.style.left = Math.max(0, Math.min(100, x)) + '%';
        p.style.top = Math.max(0, Math.min(100, y)) + '%';
        p.style.animationDelay = (Math.random() * 5) + 's';
        p.style.animationDuration = (4 + Math.random() * 3) + 's';
        const sz = Math.random() > 0.7 ? '4px' : (Math.random() > 0.4 ? '3px' : '2px');
        p.style.width = sz;
        p.style.height = sz;
        container.appendChild(p);
      }
    }
    
    function renderCircle(color, content) {
      const id = 'g' + Math.random().toString(36).substr(2, 9);
      const colors = {
        green: ['#00d4ff', '#35FF8B', '#9D4EDD', '#00d4ff'],
        orange: ['#FF6D00', '#FFB347', '#35FF8B', '#FF6D00'],
        blue: ['#00D9FF', '#7c3aed', '#00D9FF']
      };
      const c = colors[color];
      const stops = c.length === 3 ? 
        `<stop offset="0%" stop-color="${c[0]}"/><stop offset="50%" stop-color="${c[1]}"/><stop offset="100%" stop-color="${c[2]}"/>` :
        `<stop offset="0%" stop-color="${c[0]}"/><stop offset="33%" stop-color="${c[1]}"/><stop offset="66%" stop-color="${c[2]}"/><stop offset="100%" stop-color="${c[3]}"/>`;
      
      return `<div class="trapbar-circle-wrapper ${color}">
        <svg class="trapbar-circle-svg" viewBox="0 0 220 220">
          <defs><linearGradient id="${id}" x1="0%" y1="0%" x2="100%" y2="100%">${stops}</linearGradient></defs>
          <circle cx="110" cy="110" r="104" stroke="url(#${id})" stroke-width="6" fill="none"/>
        </svg>
        <div class="trapbar-circle-inner">${content}</div>
      </div>`;
    }
    
    function render() {
      const exercise = workout.exercises[currentExerciseIndex];
      const currentSets = completedSets[currentExerciseIndex];
      const completedCount = currentSets.filter(s => s).length;
      const progress = Math.round((completedCount / exercise.sets) * 100);
      
      const series = [];
      for (let i = 0; i < exercise.sets; i++) {
        const intensification = detectIntensification(exercise.notes, i);
        series.push({ 
          weight: exercise.weight, 
          reps: exercise.reps, 
          index: i, 
          intensification: intensification
        });
      }
      
      const firstUncompleted = currentSets.findIndex(s => !s);
      const currentSerieWeight = firstUncompleted >= 0 ? series[firstUncompleted].weight : exercise.weight;
      
      const nameParts = exercise.name.split(' ');
      const firstWord = nameParts[0] || '';
      const restWords = nameParts.slice(1).join(' ') || '';
      
      const repsNum = parseReps(exercise.reps);
      const totalVolume = exercise.weight * exercise.sets * repsNum;
      
      const html = `
        <div class="trapbar-screen">
          <div class="trapbar-particles" id="trapbar-particles"></div>
          
          <div class="trapbar-back-btn" onclick="window.location.href='home-final.html'"></div>
          
          <div class="trapbar-header">
            <div class="trapbar-trophy"></div>
            <div class="trapbar-title-wrapper">
              <h1>
                <span class="trapbar-title-white">${firstWord}</span>
                ${restWords ? '<span class="trapbar-title-cyan"> ' + restWords + '</span>' : ''}
              </h1>
              <div class="trapbar-subtitle">COMPOUND ¬∑ ${exercise.rpe ? 'RPE ' + exercise.rpe : 'EXERCICE'}</div>
            </div>
          </div>
          
          <div class="trapbar-metrics">
            <div class="trapbar-metric-card">
              <div class="trapbar-metric-icon">${getWeightIcon()}</div>
              <div class="trapbar-metric-value orange">${exercise.weight}kg</div>
              <div class="trapbar-metric-label">POIDS</div>
            </div>
            <div class="trapbar-metric-card">
              <div class="trapbar-metric-icon">${getSeriesIcon()}</div>
              <div class="trapbar-metric-value cyan">${exercise.sets}x${exercise.reps}</div>
              <div class="trapbar-metric-label">S√âRIES</div>
            </div>
            <div class="trapbar-metric-card">
              <div class="trapbar-metric-icon">${getTempoIcon()}</div>
              <div class="trapbar-metric-value green">${exercise.tempo || '3-1-2'}</div>
              <div class="trapbar-metric-label">TEMPO</div>
            </div>
            <div class="trapbar-metric-card">
              <div class="trapbar-metric-icon">${getRestIcon()}</div>
              <div class="trapbar-metric-value violet">${exercise.rest}s</div>
              <div class="trapbar-metric-label">REPOS</div>
            </div>
          </div>
         <!-- Bouton Timer -->
          <div class="timer-button-container">
            <button class="timer-start-btn" onclick="startTimerNeuroFit()">
              <span class="timer-icon">üéØ</span>
              <span class="timer-text">D√âMARRER LE TIMER</span>
            </button>
          </div> 
          <div class="trapbar-circles-container">
            ${renderCircle('green', `<div class="trapbar-circle-check">‚úì</div><div class="trapbar-circle-progress">${progress}%</div>`)}
            ${renderCircle('orange', `<div class="trapbar-circle-weight">${currentSerieWeight}</div><div class="trapbar-circle-unit">kg</div>`)}
            ${renderCircle('blue', `<div class="trapbar-circle-reps">${repsNum}</div><div class="trapbar-circle-reps-label">reps</div>`)}
          </div>
          
          <div class="trapbar-series-list">
            ${series.map((s, i) => {
              const isCompleted = currentSets[s.index];
              const chk = isCompleted ? 'completed' : (i === firstUncompleted ? 'uncompleted-first' : (i === firstUncompleted + 1 ? 'uncompleted-gray' : 'uncompleted-beige'));
              const row = isCompleted ? ' completed' : '';
              
              let center;
              if (s.intensification) {
                center = `<div class="trapbar-serie-center">
                  <div class="trapbar-serie-badge ${s.intensification.type}">${s.intensification.label}</div>
                  <div class="trapbar-serie-tempo">${exercise.tempo || '3-1-2'}</div>
                </div>`;
              } else {
                center = `<div class="trapbar-serie-center">
                  <div class="trapbar-serie-text">${s.weight} kg</div>
                  <div class="trapbar-serie-tempo">${exercise.tempo || '3-1-2'}</div>
                </div>`;
              }
              
              return `<div class="trapbar-serie-row${row}">
                <div class="trapbar-serie-small-circle">
                  <div class="trapbar-serie-small-num">${s.weight}</div>
                  <div class="trapbar-serie-small-unit">kg</div>
                </div>
                ${center}
                <div class="trapbar-serie-reps-badge">${s.reps}</div>
                <div class="trapbar-serie-checkbox ${chk}" onclick="window.toggleSet(${i})"></div>
              </div>`;
            }).join('')}
          </div>
          
          <div class="nav-buttons">
            <button class="nav-btn prev" onclick="window.goToPrevious()" ${currentExerciseIndex === 0 ? 'disabled' : ''}>‚Üê Pr√©c√©dent</button>
            <button class="nav-btn next" onclick="window.goToNext()" ${currentExerciseIndex === workout.exercises.length - 1 ? 'disabled' : ''}>Suivant ‚Üí</button>
          </div>
          
          <div class="trapbar-footer">
            <div class="trapbar-footer-top">
              <div>
                <div class="trapbar-footer-label">CHRONO TOTAL</div>
                <div class="trapbar-timer" id="trapbar-timer">0:00</div>
              </div>
              <div style="text-align: right;">
                <div class="trapbar-footer-label">VOLUME</div>
                <div class="trapbar-volume">${totalVolume.toLocaleString()} KG</div>
              </div>
            </div>
            <div>
              <div class="tempo-bar-container">
                <div class="tempo-bar" id="tempo-bar"></div>
              </div>
              <div class="tempo-phases">
                <div class="tempo-phase" id="tempo-phase-0">Descente</div>
                <div class="tempo-phase" id="tempo-phase-1">Pause</div>
                <div class="tempo-phase" id="tempo-phase-2">Mont√©e</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('app').innerHTML = html;
      createParticles();
      updateTempoPhases();
    }
    
    window.toggleSet = toggleSet;
    window.goToPrevious = goToPrevious;
    window.goToNext = goToNext;
    
    render();
// Fonction pour d√©marrer le timer NeuroFit
    window.startTimerNeuroFit = function() {
      const params = new URLSearchParams(window.location.search);
      const week = params.get("week") || 1;
      const day = params.get("day") || "dimanche";
      window.location.href = `workout-timer-neurofit.html?week=${week}&day=${day}`;
    };
  </script>
</body>
</html>
