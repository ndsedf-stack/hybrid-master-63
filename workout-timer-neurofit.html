<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NeuroFit Timer - Mode Hybride</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0A0A0A;
            color: #FFFFFF;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .header {
            position: relative;
            z-index: 100;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(10,10,10,0.95) 0%, rgba(10,10,10,0) 100%);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .week-tag {
            background: rgba(0,217,255,0.15);
            border: 1px solid rgba(0,217,255,0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #00D9FF;
        }

        .streak {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,51,102,0.15);
            border: 1px solid rgba(255,51,102,0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #FF3366;
        }

        .timer-container {
            position: relative;
            height: calc(100vh - 280px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .circular-timer {
            position: relative;
            width: 320px;
            height: 320px;
        }

        .circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        .circle-session { width: 320px; height: 320px; border: 3px solid rgba(255,255,255,0.05); }
        .circle-exercise { width: 270px; height: 270px; border: 3px solid rgba(0,255,136,0.1); }
        .circle-set { width: 220px; height: 220px; border: 3px solid rgba(157,78,221,0.15); }
        .circle-rep { width: 170px; height: 170px; }

        .center-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }

        .time-display {
            font-size: 64px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00D9FF 0%, #FF3366 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 2s ease-in-out infinite;
        }

        .phase-display {
            font-size: 18px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .phase-icon {
            font-size: 24px;
            animation: pulse 1s ease-in-out infinite;
        }

        .validation-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15,15,15,0.98);
            border: 2px solid rgba(0,217,255,0.3);
            border-radius: 24px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .validation-modal.active { opacity: 1; pointer-events: all; }

        .validation-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #00FF88;
        }

        .validation-subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 25px;
        }

        .validation-buttons {
            display: flex;
            gap: 12px;
        }

        .val-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .val-btn-yes {
            background: linear-gradient(135deg, #00FF88 0%, #00D9FF 100%);
            color: #000000;
        }

        .val-btn-no {
            background: rgba(255,51,102,0.2);
            border: 1px solid rgba(255,51,102,0.5);
            color: #FF3366;
        }

        .val-btn:active { transform: scale(0.95); }

        .set-complete-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15,15,15,0.98);
            border: 2px solid rgba(0,255,136,0.5);
            border-radius: 24px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .set-complete-modal.active { opacity: 1; pointer-events: all; }

        .set-complete-title { font-size: 48px; margin-bottom: 10px; }
        .set-complete-text { font-size: 20px; font-weight: 700; color: #00FF88; margin-bottom: 20px; }

        .set-stats {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .set-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        .set-stat-value { color: #00D9FF; font-weight: 600; }

        .adjust-reps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .adjust-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .adjust-value {
            font-size: 32px;
            font-weight: 700;
            color: #00D9FF;
            min-width: 50px;
        }

        .tempo-bar-container { padding: 0 20px 20px; }

        .tempo-bar {
            display: flex;
            gap: 8px;
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .tempo-phase {
            flex: 1;
            text-align: center;
            padding: 12px 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            transition: all 0.3s ease;
        }

        .tempo-phase.active {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0,217,255,0.5);
        }

        .tempo-phase-icon { font-size: 20px; margin-bottom: 4px; }
        .tempo-phase-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin: 8px 0; overflow: hidden; }
        .tempo-phase-progress { height: 100%; width: 0%; border-radius: 2px; transition: width 0.1s linear; }
        .tempo-phase-time { font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.5); }

        .tempo-phase.descent.active { background: rgba(0,217,255,0.15); border: 1px solid rgba(0,217,255,0.3); }
        .tempo-phase.descent .tempo-phase-icon { color: #00D9FF; }
        .tempo-phase.descent .tempo-phase-progress { background: #00D9FF; }

        .tempo-phase.pause.active { background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.3); }
        .tempo-phase.pause .tempo-phase-icon { color: #FFD700; }
        .tempo-phase.pause .tempo-phase-progress { background: #FFD700; }

        .tempo-phase.lift.active { background: rgba(255,51,102,0.15); border: 1px solid rgba(255,51,102,0.3); }
        .tempo-phase.lift .tempo-phase-icon { color: #FF3366; }
        .tempo-phase.lift .tempo-phase-progress { background: #FF3366; }

        .exercise-info {
            padding: 20px;
            text-align: center;
            background: rgba(255,255,255,0.02);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .exercise-name { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #FFFFFF; }
        .exercise-details { font-size: 14px; color: rgba(255,255,255,0.6); display: flex; align-items: center; justify-content: center; gap: 15px; }

        .actions { padding: 20px; display: flex; gap: 12px; }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-pause { background: rgba(255,255,255,0.1); color: #FFFFFF; border: 1px solid rgba(255,255,255,0.2); }
        .btn-pause:active { transform: scale(0.95); }
        .btn-skip { background: rgba(255,51,102,0.2); border: 1px solid rgba(255,51,102,0.5); color: #FF3366; }
        .btn-skip:active { transform: scale(0.95); }

        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle { transition: stroke-dashoffset 0.3s ease; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(0,217,255,0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(255,51,102,0.5)); }
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #00D9FF;
            border-radius: 50%;
            pointer-events: none;
            animation: explode 1s ease-out forwards;
        }

        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .settings-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        .rest-mode .circle-rep { animation: breathe 4s ease-in-out infinite; }

        @keyframes breathe {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .rest-mode .time-display { color: #9D4EDD; }
        .hidden { display: none !important; }

        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,51,102,0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            max-width: 90%;
        }

        .error-title {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .error-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .error-details {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-top: 15px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-info">
            <div class="week-tag" id="weekTag">CHARGEMENT...</div>
            <div class="streak">üî• <span id="streakCount">0</span></div>
        </div>
        <div class="settings-btn">‚öôÔ∏è</div>
    </div>

    <div class="timer-container" id="timerContainer">
        <div class="circular-timer">
            <svg class="circle circle-session" viewBox="0 0 320 320">
                <circle class="progress-ring-circle" stroke="rgba(255,255,255,0.1)" stroke-width="3" fill="transparent" r="157" cx="160" cy="160" id="sessionCircle" style="stroke-dasharray: 986; stroke-dashoffset: 493;" />
            </svg>

            <svg class="circle circle-exercise" viewBox="0 0 270 270">
                <circle class="progress-ring-circle" stroke="#00FF88" stroke-width="4" fill="transparent" r="132" cx="135" cy="135" id="exerciseCircle" style="stroke-dasharray: 829; stroke-dashoffset: 207;" />
            </svg>

            <svg class="circle circle-set" viewBox="0 0 220 220">
                <circle class="progress-ring-circle" stroke="#9D4EDD" stroke-width="5" fill="transparent" r="107" cx="110" cy="110" id="setCircle" style="stroke-dasharray: 672; stroke-dashoffset: 403;" />
            </svg>

            <svg class="circle circle-rep" viewBox="0 0 170 170">
                <defs>
                    <linearGradient id="tempoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#00D9FF;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#FFD700;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#FF3366;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle class="progress-ring-circle" stroke="url(#tempoGradient)" stroke-width="8" fill="transparent" r="78" cx="85" cy="85" id="tempoCircle" style="stroke-dasharray: 490; stroke-dashoffset: 0;" />
            </svg>

            <div class="center-display">
                <div class="time-display" id="timeDisplay">0.0</div>
                <div class="phase-display">
                    <span class="phase-icon" id="phaseIcon">‚è≥</span>
                    <span id="phaseText">CHARGEMENT</span>
                </div>
            </div>
        </div>

        <div class="validation-modal" id="validationModal">
            <div class="validation-title">‚úì REP <span id="valRepNumber">1</span>/<span id="valTotalReps">8</span></div>
            <div class="validation-subtitle">Tempo respect√© ?</div>
            <div class="validation-buttons">
                <button class="val-btn val-btn-yes" id="btnYes">
                    <span style="font-size: 28px;">‚úì</span>
                    <span>OUI</span>
                </button>
                <button class="val-btn val-btn-no" id="btnNo">
                    <span style="font-size: 28px;">‚ö†Ô∏è</span>
                    <span>NON</span>
                </button>
            </div>
        </div>

        <div class="set-complete-modal" id="setCompleteModal">
            <div class="set-complete-title">üéâ</div>
            <div class="set-complete-text">S√âRIE TERMIN√âE !</div>
            
            <div class="set-stats">
                <div class="set-stat-row">
                    <span>Reps compl√©t√©es</span>
                    <span class="set-stat-value"><span id="statsReps">0</span>/<span id="statsRepsTotal">0</span></span>
                </div>
                <div class="set-stat-row">
                    <span>Tempo respect√©</span>
                    <span class="set-stat-value"><span id="statsTempo">0</span>/<span id="statsTempoTotal">0</span></span>
                </div>
                <div class="set-stat-row">
                    <span>Time Under Tension</span>
                    <span class="set-stat-value"><span id="statsTUT">0</span>s</span>
                </div>
            </div>

            <div style="margin-bottom: 15px; color: rgba(255,255,255,0.6); font-size: 14px;">
                Ajuster les reps si n√©cessaire
            </div>

            <div class="adjust-reps">
                <button class="adjust-btn" id="btnMinus">‚àí</button>
                <div class="adjust-value" id="adjustValue">0</div>
                <button class="adjust-btn" id="btnPlus">+</button>
            </div>

            <div class="validation-buttons">
                <button class="val-btn val-btn-yes" id="btnValidate">
                    <span style="font-size: 28px;">‚úì</span>
                    <span>VALIDER</span>
                </button>
            </div>
        </div>
    </div>

    <div class="tempo-bar-container">
        <div class="tempo-bar">
            <div class="tempo-phase descent active">
                <div class="tempo-phase-icon">‚¨áÔ∏è</div>
                <div class="tempo-phase-bar">
                    <div class="tempo-phase-progress" id="descentProgress" style="width: 0%"></div>
                </div>
                <div class="tempo-phase-time" id="descentTime">0s</div>
            </div>
            <div class="tempo-phase pause">
                <div class="tempo-phase-icon">‚è∏Ô∏è</div>
                <div class="tempo-phase-bar">
                    <div class="tempo-phase-progress" id="pauseProgress" style="width: 0%"></div>
                </div>
                <div class="tempo-phase-time" id="pauseTime">0s</div>
            </div>
            <div class="tempo-phase lift">
                <div class="tempo-phase-icon">‚¨ÜÔ∏è</div>
                <div class="tempo-phase-bar">
                    <div class="tempo-phase-progress" id="liftProgress" style="width: 0%"></div>
                </div>
                <div class="tempo-phase-time" id="liftTime">0s</div>
            </div>
        </div>
    </div>

    <div class="exercise-info">
        <div class="exercise-name" id="exerciseName">CHARGEMENT...</div>
        <div class="exercise-details">
            <span id="exerciseWeight">üí™ 0kg</span>
            <span>‚Ä¢</span>
            <span>SET <span id="currentSet">0</span>/<span id="totalSets">0</span></span>
            <span>‚Ä¢</span>
            <span id="exerciseReps">0 reps</span>
            <span>‚Ä¢</span>
            <span id="exerciseTempo">Tempo 0-0-0</span>
        </div>
    </div>

    <div class="actions">
        <button class="btn btn-pause" id="pauseBtn">
            <span>‚è∏Ô∏è</span>
            <span>PAUSE</span>
        </button>
        <button class="btn btn-skip" id="skipBtn">
            <span>‚è≠Ô∏è</span>
            <span>SKIP</span>
        </button>
    </div>

    <script type="module">
        // ========================================
        // üî• INT√âGRATION PROGRAM-DATA.JS
        // ========================================
        
        // Import des donn√©es (assure-toi que le chemin est correct)
        import { PROGRAM_DATA } from './scripts/program-data.js';

        // R√©cup√©rer les param√®tres URL
        const urlParams = new URLSearchParams(window.location.search);
        const weekNumber = parseInt(urlParams.get('week')) || 1;
        const dayName = urlParams.get('day') || 'dimanche';

        console.log('üìç Chargement:', { week: weekNumber, day: dayName });

        // Fonction pour afficher une erreur
        function showError(title, message, details = '') {
            document.body.innerHTML = `
                <div class="error-message">
                    <div class="error-title">${title}</div>
                    <div class="error-text">${message}</div>
                    ${details ? `<div class="error-details">${details}</div>` : ''}
                </div>
            `;
        }

        // V√©rifier que PROGRAM_DATA existe
        if (!PROGRAM_DATA || !PROGRAM_DATA.weeks) {
            showError('‚ùå', 'Erreur: PROGRAM_DATA introuvable', 
                'V√©rifie que scripts/program-data.js existe et exporte correctement PROGRAM_DATA');
            throw new Error('PROGRAM_DATA non trouv√©');
        }

        // Trouver la semaine
        const weekData = PROGRAM_DATA.weeks.find(w => w.week_number === weekNumber);
        if (!weekData) {
            showError('‚ùå', `Semaine ${weekNumber} introuvable`, 
                `Semaines disponibles: ${PROGRAM_DATA.weeks.map(w => w.week_number).join(', ')}`);
            throw new Error(`Semaine ${weekNumber} non trouv√©e`);
        }

        // Trouver le jour
        const dayData = weekData.days[dayName];
        if (!dayData) {
            showError('‚ùå', `Jour "${dayName}" introuvable`, 
                `Jours disponibles: ${Object.keys(weekData.days).join(', ')}`);
            throw new Error(`Jour ${dayName} non trouv√©`);
        }

        // R√©cup√©rer les exercices
        const exercises = dayData.exercises;
        if (!exercises || exercises.length === 0) {
            showError('‚ùå', 'Aucun exercice trouv√©', 
                `La journ√©e "${dayName}" de la semaine ${weekNumber} n'a pas d'exercices`);
            throw new Error('Aucun exercice');
        }

        // Exercice actuel (premier pour l'instant)
        let currentExerciseIndex = 0;
        const currentExercise = exercises[currentExerciseIndex];

        console.log('‚úÖ Donn√©es charg√©es:', {
            week: weekData.week_number,
            day: dayName,
            exercise: currentExercise.name,
            exercises: exercises.length
        });

        // Parser le tempo (ex: "3-1-2" ‚Üí [3, 1, 2] ou "3010" ‚Üí [3, 0, 1, 0])
        function parseTempo(tempoStr) {
            if (!tempoStr) return [3, 1, 2]; // D√©faut
            
            // Si format "3-1-2"
            if (tempoStr.includes('-')) {
                return tempoStr.split('-').map(Number);
            }
            
            // Si format "3010"
            return tempoStr.split('').map(Number);
        }

        const tempo = parseTempo(currentExercise.tempo);
        console.log('‚è±Ô∏è Tempo pars√©:', tempo, 'depuis', currentExercise.tempo);

        // ========================================
        // üéØ STATE INITIALIS√â AVEC LES DONN√âES
        // ========================================
        
        let state = {
            phase: 0,
            rep: 1,
            set: 1,
            totalReps: currentExercise.reps || 8,
            totalSets: currentExercise.sets || 5,
            tempo: tempo,
            timeRemaining: tempo[0],
            isPaused: false,
            isResting: false,
            restTime: currentExercise.rest || 90,
            tempoRespected: [],
            repsCompleted: 0,
            exerciseName: currentExercise.name,
            weight: currentExercise.weight || 0,
            weekNumber: weekNumber,
            dayName: dayName,
            currentExerciseIndex: 0,
            totalExercises: exercises.length
        };

        let timerInterval;

        // Elements
        const timeDisplay = document.getElementById('timeDisplay');
        const phaseIcon = document.getElementById('phaseIcon');
        const phaseText = document.getElementById('phaseText');
        const tempoCircle = document.getElementById('tempoCircle');
        const validationModal = document.getElementById('validationModal');
        const setCompleteModal = document.getElementById('setCompleteModal');
        const valRepNumber = document.getElementById('valRepNumber');
        const valTotalReps = document.getElementById('valTotalReps');
        const timerContainer = document.getElementById('timerContainer');
        const currentSetDisplay = document.getElementById('currentSet');
        const totalSetsDisplay = document.getElementById('totalSets');

        const descentProgress = document.getElementById('descentProgress');
        const pauseProgress = document.getElementById('pauseProgress');
        const liftProgress = document.getElementById('liftProgress');
        const tempoPhases = document.querySelectorAll('.tempo-phase');

        const phases = [
            { name: 'DESCENT', icon: '‚¨áÔ∏è', color: '#00D9FF' },
            { name: 'PAUSE', icon: '‚è∏Ô∏è', color: '#FFD700' },
            { name: 'LIFT', icon: '‚¨ÜÔ∏è', color: '#FF3366' }
        ];

        // ========================================
        // üé® INITIALISER L'AFFICHAGE
        // ========================================
        
        function initDisplay() {
            // Header
            document.getElementById('weekTag').textContent = 
                `SEMAINE ${state.weekNumber} ‚Ä¢ ${state.dayName.toUpperCase()}`;
            
            // Exercice info
            document.getElementById('exerciseName').textContent = state.exerciseName;
            document.getElementById('exerciseWeight').textContent = `üí™ ${state.weight}kg`;
            document.getElementById('exerciseReps').textContent = `${state.totalReps} reps`;
            document.getElementById('exerciseTempo').textContent = `Tempo ${state.tempo.join('-')}`;
            
            // Set info
            currentSetDisplay.textContent = state.set;
            totalSetsDisplay.textContent = state.totalSets;
            
            // Tempo bar
            document.getElementById('descentTime').textContent = state.tempo[0] + 's';
            document.getElementById('pauseTime').textContent = state.tempo[1] + 's';
            document.getElementById('liftTime').textContent = state.tempo[2] + 's';
            
            // Validation modal
            valTotalReps.textContent = state.totalReps;
            document.getElementById('statsRepsTotal').textContent = state.totalReps;
            document.getElementById('statsTempoTotal').textContent = state.totalReps;
            
            console.log('‚úÖ Affichage initialis√©');
        }

        function startTimer() {
            timerInterval = setInterval(updateTimer, 100);
        }

        function updateTimer() {
            if (state.isPaused) return;

            state.timeRemaining -= 0.1;

            if (state.timeRemaining <= 0) {
                nextPhase();
            }

            updateDisplay();
            updateProgressBars();
        }

        function updateDisplay() {
            if (state.isResting) {
                timeDisplay.textContent = formatTime(state.timeRemaining);
                phaseIcon.textContent = 'üü£';
                phaseText.textContent = 'REPOS';
                timerContainer.classList.add('rest-mode');
            } else {
                timeDisplay.textContent = state.timeRemaining.toFixed(1);
                phaseIcon.textContent = phases[state.phase].icon;
                phaseText.textContent = phases[state.phase].name;
                timerContainer.classList.remove('rest-mode');

                const circumference = 490;
                const progress = 1 - (state.timeRemaining / state.tempo[state.phase]);
                const offset = circumference * (1 - progress);
                tempoCircle.style.strokeDashoffset = offset;
            }
        }

        function updateProgressBars() {
            if (state.isResting) return;

            const progress = ((state.tempo[state.phase] - state.timeRemaining) / state.tempo[state.phase]) * 100;
            
            descentProgress.style.width = '0%';
            pauseProgress.style.width = '0%';
            liftProgress.style.width = '0%';

            if (state.phase === 0) descentProgress.style.width = progress + '%';
            if (state.phase === 1) pauseProgress.style.width = progress + '%';
            if (state.phase === 2) liftProgress.style.width = progress + '%';

            tempoPhases.forEach((phase, i) => {
                phase.classList.toggle('active', i === state.phase);
            });
        }

        function nextPhase() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }

            state.phase++;

            if (state.phase >= 3) {
                showValidation();
                return;
            }

            state.timeRemaining = state.tempo[state.phase];
        }

        function showValidation() {
            clearInterval(timerInterval);
            valRepNumber.textContent = state.rep;
            validationModal.classList.add('active');
        }

        function hideValidation() {
            validationModal.classList.remove('active');
        }

        function continueToNextRep(tempoOk) {
            hideValidation();
            
            state.tempoRespected.push(tempoOk);
            state.repsCompleted++;
            state.rep++;
            state.phase = 0;
            state.timeRemaining = state.tempo[0];

            if (state.rep > state.totalReps) {
                showSetComplete();
            } else {
                createParticles();
                startTimer();
            }
        }

        function showSetComplete() {
            const tempoOk = state.tempoRespected.filter(t => t).length;
            const tut = state.repsCompleted * state.tempo.reduce((a, b) => a + b, 0);

            document.getElementById('statsReps').textContent = state.repsCompleted;
            document.getElementById('statsTempo').textContent = tempoOk;
            document.getElementById('statsTUT').textContent = tut;
            document.getElementById('adjustValue').textContent = state.repsCompleted;

            setCompleteModal.classList.add('active');

            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        }

        function hideSetComplete() {
            setCompleteModal.classList.remove('active');
        }

        function validateSet() {
            hideSetComplete();
            
            console.log('‚úÖ S√©rie sauvegard√©e:', {
                exercise: state.exerciseName,
                set: state.set,
                reps: state.repsCompleted,
                tempo: state.tempoRespected.filter(t => t).length + '/' + state.repsCompleted,
                tut: state.repsCompleted * state.tempo.reduce((a, b) => a + b, 0)
            });

            startRest();
        }

        function startRest() {
            state.isResting = true;
            state.timeRemaining = state.restTime;
            startTimer();
        }

        function endRest() {
            state.isResting = false;
            state.set++;
            state.rep = 1;
            state.repsCompleted = 0;
            state.tempoRespected = [];
            state.phase = 0;
            state.timeRemaining = state.tempo[0];

            currentSetDisplay.textContent = state.set;

            if (state.set > state.totalSets) {
                exerciseComplete();
                return;
            }

            startTimer();
        }

        function exerciseComplete() {
            clearInterval(timerInterval);
            
            console.log('üèÜ Exercice termin√©:', state.exerciseName);
            
            // Passer √† l'exercice suivant
            state.currentExerciseIndex++;
            
            if (state.currentExerciseIndex >= state.totalExercises) {
                // Tous les exercices termin√©s
                alert('üéâ S√âANCE TERMIN√âE ! F√©licitations !');
                // TODO: Rediriger vers la page de r√©sum√©
                return;
            }
            
            // Charger l'exercice suivant
            loadNextExercise();
        }

        function loadNextExercise() {
            const nextExercise = exercises[state.currentExerciseIndex];
            
            // Mettre √† jour le state
            state.exerciseName = nextExercise.name;
            state.weight = nextExercise.weight || 0;
            state.totalReps = nextExercise.reps || 8;
            state.totalSets = nextExercise.sets || 5;
            state.tempo = parseTempo(nextExercise.tempo);
            state.restTime = nextExercise.rest || 90;
            state.set = 1;
            state.rep = 1;
            state.repsCompleted = 0;
            state.tempoRespected = [];
            state.phase = 0;
            state.timeRemaining = state.tempo[0];
            
            // R√©initialiser l'affichage
            initDisplay();
            
            console.log('‚û°Ô∏è Exercice suivant:', nextExercise.name);
            
            // Afficher une notification
            alert(`Exercice suivant : ${nextExercise.name}`);
            
            // Red√©marrer le timer
            startTimer();
        }

        function createParticles() {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const angle = (Math.PI * 2 * i) / 12;
                const distance = 100;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ========================================
        // üéÆ EVENT LISTENERS
        // ========================================

        document.getElementById('btnYes').addEventListener('click', () => {
            continueToNextRep(true);
        });

        document.getElementById('btnNo').addEventListener('click', () => {
            continueToNextRep(false);
        });

        document.getElementById('btnValidate').addEventListener('click', () => {
            const adjustedReps = parseInt(document.getElementById('adjustValue').textContent);
            state.repsCompleted = adjustedReps;
            validateSet();
        });

        document.getElementById('btnMinus').addEventListener('click', () => {
            const current = parseInt(document.getElementById('adjustValue').textContent);
            if (current > 0) {
                document.getElementById('adjustValue').textContent = current - 1;
            }
        });

        document.getElementById('btnPlus').addEventListener('click', () => {
            const current = parseInt(document.getElementById('adjustValue').textContent);
            if (current < state.totalReps) {
                document.getElementById('adjustValue').textContent = current + 1;
            }
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            state.isPaused = !state.isPaused;
            document.getElementById('pauseBtn').innerHTML = state.isPaused 
                ? '<span>‚ñ∂Ô∏è</span><span>REPRENDRE</span>' 
                : '<span>‚è∏Ô∏è</span><span>PAUSE</span>';
        });

        document.getElementById('skipBtn').addEventListener('click', () => {
            if (confirm('Passer √† l\'exercice suivant ?')) {
                exerciseComplete();
            }
        });

        // Check for rest mode end
        setInterval(() => {
            if (state.isResting && state.timeRemaining <= 0) {
                endRest();
            }
        }, 100);

        // ========================================
        // üöÄ INITIALISATION
        // ========================================

        console.log('üöÄ Initialisation du timer...');
        initDisplay();
        startTimer();
        console.log('‚úÖ Timer d√©marr√© !');
    </script>
</body>
</html>
